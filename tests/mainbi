# -*- coding: utf-8 -*-
# @Time    : 2019/9/11 15:06
# @Author  : alvin
# @File    : sidc.py
# @Software: PyCharm
# import  unittest

import time as t
import random
import requests
import json
import datetime
from utils.logger import Logger
from utils.public import data_dir_file
from utils.operationExcel_writedata import Data_Excel_Action


class Test_Mainbi():
    '''
    进行mainbi
    :return:
    '''

    def setUp(self):
        pass

    def __init__(self):
        '''初始配置'''
        self.log = Logger()
        self.filename = data_dir_file( dirPath='MainBi',
                                       fileName="ManinBi_demo.xlsx" )
        self.excel = Data_Excel_Action()

    def write_mainbi_data(self):
        '''接口数据'''
        res = requests.get(
            "https://dncapi.bqrank.net/api/coin/web-coinrank?page=1&type=-1&pagesize=100&webp=1" )

        if 200 == res.json()['code']:
            if res.json()['msg'] == "success":
                data = []
                for i in range(int( res.json()['maxpage'])):
                    list_data = []
                    list_data.append( (datetime.datetime.now() ).strftime("%Y-%m-%d %H:%M:%S" ) )
                    list_data.append( res.json()['data'][i]['rank'])
                    list_data.append( res.json()['data'][i]['fullname'])
                    list_data.append( res.json()['data'][i]['name'])
                    list_data.append( res.json()['data'][i]['market_value'])
                    list_data.append( res.json()['data'][i]['current_price'])
                    list_data.append( res.json()['data'][i]['turnoverrate'])
                    '''非btc数据兑换处理'''
                    if 0==i:
                        list_data.append( (res.json()['data'][i]['current_price'])/(res.json()['data'][i]['current_price']) )
                    else:
                        list_data.append( format((res.json()['data'][0]['current_price'])/(res.json()['data'][i]['current_price']),'.3f') )
                    data.append( list_data )
                    '''btc可兑换eth单独写文件方便后续展示'''
                    if res.json()['data'][i]['name'] == 'ETH':
                        self.excel.awrite_ethhistorydata(data[1])
                    # print(data)
                file_name = self.excel.write_alldata( data )


if __name__ == '__main__':
    Test = Test_Mainbi()
    Test.write_mainbi_data()
